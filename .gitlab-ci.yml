image: node:8-alpine

cache:
    paths:
        - node_modules/

stages:
    - lint
    - build
    - deploy

lint:
    stage: lint
    script:
        - yarn
        - yarn run lint

build:
    stage: build
    script:
        - yarn
        - yarn run build

deploy:
    stage: deploy
    when: manual
    variables:
        SSH_HOST: "warcraftjournal.org"
        SSH_PORT: 2222
    script:
        - apk add --update git openssh-client
        - mkdir -p ~/.ssh
        - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
        - chmod 600 ~/.ssh/id_rsa
        - ssh-keyscan -p $SSH_PORT -H '$SSH_HOST' >> ~/.ssh/known_hosts
        - echo -e 'Host $SSH_HOST\n    Port $SSH_PORT' >> ~/.ssh/config
        - git push dokku@$SSH_HOST:warcraftjournal-staging master